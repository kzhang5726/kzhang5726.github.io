<canvas id="ctx" width="500" height="500" style="border:1px solid #000000;"> </canvas>

<script> 
var ctx = document.getElementById("ctx").getContext("2d"); 
ctx.font = '30px Arial';

var HEIGHT = 500;
var WIDTH = 500;
var timeWhenGameStarted = Date.now();	//return time in ms
var framecount = 0;
var score = 0;

var player = {
	x:50,
	spdX:30,
	y:40,
	spdY:5,
	name:'P',
	hp:10,
	width:20,
	height:20,
	color:'blue',
	atkSpd:1,
	atkcounter:0,
	up:false,
	down:false,
	left:false,
	right:false,
};

var enemyList = {};
var upgrades = {};
var bullets = {};


getDistanceBetweenEntity = function (entity1,entity2){	//return distance (number)
	var vx = entity1.x - entity2.x;
	var vy = entity1.y - entity2.y;
	return Math.sqrt(vx*vx+vy*vy);
}

testCollisionEntity = function (entity1,entity2){	//return if colliding (true/false)
	var rect1 = {
		x:entity1.x-entity1.width/2,
		y:entity1.y-entity1.height/2,
		width:entity1.width,
		height:entity1.height,
	}
	var rect2 = {
		x:entity2.x-entity2.width/2,
		y:entity2.y-entity2.height/2,
		width:entity2.width,
		height:entity2.height,
	}
	return testCollisionRectRect(rect1,rect2);
	
}

Enemy = function (id,x,y,spdX,spdY,width,height){
	var enemy3 = {
		x:x,
		spdX:spdX,
		y:y,
		spdY:spdY,
		name:'E',
		id:id,
		width:width,
		height:height,
		color:'red',
		aimAngle:0
	};
	enemyList[id] = enemy3;
	
}

Upgrade = function (id,x,y,spdX,spdY,width,height,color,type,score){
	var upgrade = {
		x:x,
		spdX:spdX,
		y:y,
		spdY:spdY,
		name:'U',
		id:id,
		width:width,
		height:height,
		color:color,
		type:type,
		score:score
	};
	upgrades[id] = upgrade;
	
}

Bullet = function (id,x,y,spdX,spdY,width,height){
	var bullet = {
		x:x,
		spdX:spdX,
		y:y,
		spdY:spdY,
		name:'B',
		id:id,
		width:width,
		height:height,
		color:'gray',
		timer:0
	};
	bullets[id] = bullet;
	
}

randomEnemy = function(){
    var x = Math.random() * WIDTH;
    var y = Math.random() * HEIGHT;
    var spdX = 5 + Math.random()*5;
    var spdY = 5 + Math.random()*5;
    var id = Math.random();
    var width = 10 + Math.random()*30;
    var height = 10 + Math.random()*30;
    Enemy(id, x , y, spdX, spdY, width, height);
}

randomUpgrade = function(){
    var x = Math.random() * WIDTH;
    var y = Math.random() * HEIGHT;
    var spdX = 0;
    var spdY = 0;
    var id = Math.random();
    var width = 10;
    var height = 10;
	var type;
	var color;
	var score;
	if(Math.random() < 0.7){
		type = 'score';
		color = 'orange'
	}
	else{
		type = 'atkspd';
		color = 'green';
	}
    Upgrade(id, x , y, spdX, spdY, width, height,type,color,score);
}

randomBullet = function(actor, new_angle){
    var x = actor.x;
    var y = actor.y;
    var height = 10;
    var width = 10;
    var id = Math.random();
    var angle = actor.aimAngle;

	if(new_angle != undefined){
		angle = new_angle;
	}

    var spdX = Math.cos(angle)*25;
    var spdY = Math.sin(angle)*25;
    Bullet(id, x , y, spdX, spdY, width, height);
}

document.onmousemove = function(mouse){
	var mouseX = mouse.clientX - 8;
	var mouseY = mouse.clientY - 8;

	mouseX -= player.x;
	mouseY -= player.y;
	
	player.aimAngle = Math.atan2(mouseY,mouseX) / Math.PI * 180;

}

document.onclick = function(mouse){
	if(player.atkcounter > 25){
        randomBullet(player);
		player.atkcounter = 0;
    }
}

document.oncontextmenu = function(mouse){
	if(player.atkcounter > 100){
		
		for(var i = 0; i < 360; i++){
			randomBullet(player, i);
		}
		player.atkcounter = 0;
	}
	mouse.preventDefault();
}

document.onkeydown = function(event){
	switch(event.keyCode){
		case 68:
			player.right = true;
			break;
		case 83:
			player.down = true;
			break;
		case 65:
			player.left = true;
			break;
		case 87:
			player.up = true;
			break;
	}
}

document.onkeyup = function(event){
	switch(event.keyCode){
		case 68:
			player.right = false;
			break;
		case 83:
			player.down = false;
			break;
		case 65:
			player.left = false;
			break;
		case 87:
			player.up = false;
			break;
	}
}

updatePlayerPosition = function(event){
	if(player.right){
		player.x += 10;
	}
	if(player.left){
		player.x -= 10;
	}
	if(player.down){
		player.y -= 10;
	}
	if(player.up){
		player.y += 10;
	}
	if(player.x < player.width/2){
        player.x = player.width/2;
    }
    if(player.x > WIDTH - player.width/2){
        player.x = WIDTH - player.width/2;
    }
    if(player.y < player.height/2){
        player.y = player.height/2;
    }
    if(player.y > HEIGHT - player.height/2){
        player.y = HEIGHT - player.height/2;
    }
}

updateEntity = function (something){
	updateEntityPosition(something);
	drawEntity(something);
}
updateEntityPosition = function(something){
	something.x += something.spdX;
	something.y += something.spdY;
			
	if(something.x < 0 || something.x > WIDTH){
		something.spdX = -something.spdX;
	}
	if(something.y < 0 || something.y > HEIGHT){
		something.spdY = -something.spdY;
	}
}

testCollisionRectRect = function(rect1,rect2){
	return rect1.x <= rect2.x+rect2.width 
		&& rect2.x <= rect1.x+rect1.width
		&& rect1.y <= rect2.y + rect2.height
		&& rect2.y <= rect1.y + rect1.height;
}


drawEntity = function(something){
	ctx.save();
	ctx.fillStyle = something.color;
	ctx.fillRect(something.x-something.width/2,something.y-something.height/2,something.width,something.height);
	ctx.restore();
}

var counter = 0;

update = function(){
    framecount++;
    score++;
	ctx.clearRect(0,0,WIDTH,HEIGHT);
    
    if(framecount%100 == 0){
        randomEnemy();
    }
    if(framecount%75 == 0){
        randomUpgrade();
    }

	player.atkcounter += player.atkSpd;
	
    for(var key in bullets){
        updateEntity(bullets[key]);
		bullets[key].timer++;

		if(bullets[key].timer > 20){
			delete bullets[key];
			continue;
		}

		if(bullets.x >= 500 || bullets.x <= 0){
			delete bullets[key];
			continue;
		}
		if(bullets.y >= 500 || bullets.y <= 0){
			delete bullets[key];
			continue;
		}

        for(var id in enemyList){
            var isColliding = testCollisionEntity(bullets[key], enemyList[id]);
            if(isColliding){
                score += 100;
                delete bullets[key];
                delete enemyList[id];
                break;
            }
        }
    }

    for(var key in upgrades){
        updateEntity(upgrades[key]);
        var isColliding = testCollisionEntity(player, upgrades[key]);
		if(isColliding){

			switch(upgrades[key].type){
				case 'score':
					score+=100;
					break;
				case 'atkspd':
					player.atkSpd+=.2;
					break;
			}
			
			delete upgrades[key];
		}
    }
	
	for(var key in enemyList){
		updateEntity(enemyList[key]);
		
		var isColliding = testCollisionEntity(player,enemyList[key]);
		if(isColliding){
			player.hp = player.hp - 1;
		}
        if(player.hp <= 0){
				var timeSurvived = Date.now() - timeWhenGameStarted;
				console.log("You lost! You survived for " + timeSurvived + " ms.");
                console.log("Score was :" + score);
                newGame();
		}
	}
	updatePlayerPosition();
	drawEntity(player);
	ctx.fillText(player.hp + " Hp",210,30);
    ctx.fillText( "Score : " + score, 10, 30);
}

newGame = function(){
    player.hp = 10;
    timeWhenGameStarted = Date.now();
    framecount = 0;
    score = 0;
    enemyList = {};
    upgrades = {};
	bullets = {};
}

newGame();


setInterval(update,40);
</script>